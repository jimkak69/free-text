<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fake Text Story Video Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/imessage.css') }}?v={{ range(1, 999999) | random }}" type="text/css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div class="stars">
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>
    <div class="page-container">
        <!-- Guide Section -->
        <div class="guide-section">
            <h1>Fake Text Story Video Generator</h1>
            <p>Welcome to GoViral My Free Text Story Generator! Create engaging text message videos with realistic conversations.</p>
            
            <p>With our generator, you can:</p>
            <ul>
                <li>Create messages for both sender and receiver</li>
                <li>Edit messages freely at any time</li>
                <li>Add fun sound effects to individual messages</li>
                <li>Choose from various voice actors for both participants</li>
                <li>Select your preferred background video style</li>
            </ul>
            
            <p><strong>Optional:</strong> To add voice narration to your messages, you'll need an ElevenLabs account. Enter your API key and click "Fetch Voices" to load all available voices from your account. You can then select voices for both sender and receiver, or leave them unselected for a silent video.</p>
            
            <p>Ready to create your viral text story? Start typing your messages and let your creativity flow!</p>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div class="container" id="chatContainer">
                <div class="header">
                    <div class="header-left">
                        <div class="back-button">â€¹</div>
                    </div>
                    <div class="header-center">
                        <div class="profile-image" id="profileImageContainer">
                            <img src="{{ url_for('static', filename='images/profile.jpg') }}" alt="Profile" id="profileImage">
                            <input type="file" id="profileUpload" accept="image/*" style="display: none;">
                        </div>
                        <div class="header-text" id="headerName" contenteditable="true" spellcheck="false">
                            John Doe
                        </div>
                    </div>
                    <div class="header-right">
                    </div>
                </div>
                <div class="message-container" id="messageContainer">
                    <div class="dynamic-container">
                        <!-- Messages will be added here -->
                    </div>
                </div>
                <div class="input-area">
                    <div class="imessage-input">
                        <input type="text" id="messageInput" placeholder="iMessage">
                        <button id="senderToggle">â‡„</button>
                        <button id="addPicture">ðŸ“·</button>
                        <input type="file" id="pictureUpload" accept="image/*" style="display: none;">
                        <button id="addMessage">Send</button>
                    </div>
                    <div class="action-buttons">
                        <button class="import-dialogue-btn" id="importDialogueBtn">Import Dialogue</button>
                        <button class="generate-button" id="generateBtn">Generate Video</button>
                    </div>
                </div>
            </div>
            
            <!-- Settings wrapper -->
            <div class="settings-wrapper">
                <div class="theme-settings">
                    <h3>Choose your theme:</h3>
                    <div class="theme-selector">
                        <input type="radio" id="lightTheme" name="theme" value="light" checked>
                        <label for="lightTheme">Light Theme</label>
                        <input type="radio" id="darkTheme" name="theme" value="dark">
                        <label for="darkTheme">Dark Theme</label>
                    </div>
                </div>
                <div class="voice-settings">
                    <h3>Choose Voice Actors</h3>
                    <div class="api-key-section">
                        <input type="text" id="elevenLabsKey" placeholder="Enter ElevenLabs API Key" class="api-key-input">
                        <button id="fetchVoicesBtn" class="fetch-voices-btn">Fetch Voices</button>
                    </div>
                    <div class="voice-selector-container">
                        <div class="voice-selector">
                            <label for="senderVoice">Sender Voice:</label>
                            <select id="senderVoice">
                                <option value="">No voice (optional)</option>
                            </select>
                        </div>
                        <div class="voice-selector">
                            <label for="receiverVoice">Receiver Voice:</label>
                            <select id="receiverVoice">
                                <option value="">No voice (optional)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="video-selection">
                    <h3>Select Background Video</h3>
                    <div class="video-previews">
                        <div class="video-option">
                            <video 
                                src="https://res.cloudinary.com/dicyxkb4t/video/upload/v1738448713/ejqmkubzg1qdxzkc7fm4.mp4" 
                                loop 
                                muted 
                                class="preview-video"
                                onmouseover="this.play()" 
                                onmouseout="this.pause(); this.currentTime = 0;"
                            ></video>
                            <input type="radio" name="background" value="background" checked>
                            <label>Style 1</label>
                        </div>
                        <div class="video-option">
                            <video 
                                src="https://res.cloudinary.com/dicyxkb4t/video/upload/v1738448707/f1bhluhc6si77uapdawe.mp4" 
                                loop 
                                muted 
                                class="preview-video"
                                onmouseover="this.play()" 
                                onmouseout="this.pause(); this.currentTime = 0;"
                            ></video>
                            <input type="radio" name="background" value="background_1">
                            <label>Style 2</label>
                        </div>
                        <div class="video-option">
                            <video 
                                src="https://res.cloudinary.com/dicyxkb4t/video/upload/v1738448708/dxo2rlb7kckps0fnfvv4.mp4" 
                                loop 
                                muted 
                                class="preview-video"
                                onmouseover="this.play()" 
                                onmouseout="this.pause(); this.currentTime = 0;"
                            ></video>
                            <input type="radio" name="background" value="background_2">
                            <label>Style 3</label>
                        </div>
                        <div class="video-option">
                            <video 
                                src="https://res.cloudinary.com/dicyxkb4t/video/upload/v1738448706/pytgss2oi9idgch1xhrw.mp4" 
                                loop 
                                muted 
                                class="preview-video"
                                onmouseover="this.play()" 
                                onmouseout="this.pause(); this.currentTime = 0;"
                            ></video>
                            <input type="radio" name="background" value="background_3">
                            <label>Style 4</label>
                        </div>
                        <div class="video-option">
                            <video 
                                src="https://res.cloudinary.com/dicyxkb4t/video/upload/v1738448705/y4k8pbdv6gwi06fo3feg.mp4" 
                                loop 
                                muted 
                                class="preview-video"
                                onmouseover="this.play()" 
                                onmouseout="this.pause(); this.currentTime = 0;"
                            ></video>
                            <input type="radio" name="background" value="background_4">
                            <label>Style 5</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Dialogue Modal -->
        <div class="import-modal" id="importModal">
            <div class="import-modal-content">
                <div class="import-modal-header">
                    <h3>Import Dialogue</h3>
                    <button class="close-modal" id="closeImportModal">&times;</button>
                </div>
                <div class="import-modal-body">
                    <p>Paste your dialogue in the format below:</p>
                    <div class="format-example">
                        <pre>A: Hi, how are you?
B: I'm fine, thanks for asking!
A: That's great to hear.
B: How about you?</pre>
                    </div>
                    <textarea 
                        id="dialogueInput" 
                        placeholder="A: Hi, how are you?&#10;B: I'm fine, thanks for asking!&#10;A: That's great to hear.&#10;B: How about you?"
                        rows="10"
                    ></textarea>
                    <div class="import-options">
                        <label>
                            <input type="radio" name="speakerMapping" value="AB" checked>
                            A = Sender, B = Receiver
                        </label>
                        <label>
                            <input type="radio" name="speakerMapping" value="BA">
                            A = Receiver, B = Sender
                        </label>
                    </div>
                </div>
                <div class="import-modal-footer">
                    <button class="cancel-btn" id="cancelImport">Cancel</button>
                    <button class="import-btn" id="confirmImport">Import Messages</button>
                </div>
            </div>
        </div>

        <!-- Add this after the chat-section div -->
        <div class="steps-guide">
            <h2>How to Use</h2>
            <div class="step">
                <div class="step-number">1</div>
                <p>Type your message in the input box and press Enter or click Send</p>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <p>Click on any message to edit, add sound effects, or manage message options</p>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <p>Click on profile image to upload your own profile image. Click on header name to edit your name.</p>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <p>Enter your ElevenLabs API key and click "Fetch Voices" to load all available voices (optional)</p>
            </div>
            <div class="step">
                <div class="step-number">5</div>
                <p>Select voice actors for both sender and receiver, or leave unselected for silent video</p>
            </div>
            <div class="step">
                <div class="step-number">6</div>
                <p>Choose your preferred background video style</p>
            </div>
            <div class="step">
                <div class="step-number">7</div>
                <p>Click "Generate Video" to create your text message video</p>
            </div>
        </div>
    </div>

    <script>
        let messages = [];
        let isSender = true;
        let isGenerating = false;

        const messageInput = document.getElementById('messageInput');
        const messageContainer = document.getElementById('messageContainer');
        const chatContainer = document.getElementById('chatContainer');
        const senderToggle = document.getElementById('senderToggle');
        const addMessageBtn = document.getElementById('addMessage');
        const generateBtn = document.getElementById('generateBtn');

        // Add picture upload functionality
        const addPictureBtn = document.getElementById('addPicture');
        const pictureUpload = document.getElementById('pictureUpload');

        addPictureBtn.addEventListener('click', () => {
            pictureUpload.value = '';
            pictureUpload.click();
        });

        pictureUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    addPictureMessage(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        function addPictureMessage(imageSrc) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSender ? 'sender' : 'receiver'} picture`;
            messageDiv.setAttribute('data-id', Date.now());
            
            const img = document.createElement('img');
            
            // Create a temporary image to get the natural dimensions
            const tempImg = new Image();
            tempImg.onload = function() {
                // Calculate dimensions while maintaining aspect ratio
                const maxWidth = 200;  // Updated max width
                const maxHeight = 300; // Updated max height
                let width = this.width;
                let height = this.height;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width = width * ratio;
                    height = height * ratio;
                }
                
                // Set the dimensions on the actual image
                img.style.width = `${width}px`;
                img.style.height = `${height}px`;
            };
            
            img.src = imageSrc;
            tempImg.src = imageSrc;
            
            messageDiv.appendChild(img);
            
            const dynamicContainer = document.querySelector('.dynamic-container');
            dynamicContainer.appendChild(messageDiv);
            
            updateMessagesArray();
            scrollToBottom();
        }

        function scrollToBottom() {
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // Function to update messages array and ensure synchronization
        function updateMessagesArray() {
            const dynamicContainer = document.querySelector('.dynamic-container');
            messages = Array.from(dynamicContainer.children).map(messageDiv => {
                const message = {
                    id: messageDiv.getAttribute('data-id') || Date.now(),
                    is_sender: messageDiv.classList.contains('sender'),
                    soundEffect: messageDiv.getAttribute('data-sound-effect') || null,
                    type: messageDiv.classList.contains('picture') ? 'picture' : 'text'
                };
                
                if (message.type === 'picture') {
                    message.text = messageDiv.querySelector('img').src;
                } else {
                    message.text = messageDiv.textContent.trim();
                }
                
                return message;
            }).filter(msg => msg.text);
            
            console.log('Updated messages array:', messages);
        }

        // Modify addMessage function
        function addMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSender ? 'sender' : 'receiver'}`;
            messageDiv.textContent = text;
            messageDiv.setAttribute('data-id', Date.now());
            
            const dynamicContainer = document.querySelector('.dynamic-container');
            dynamicContainer.appendChild(messageDiv);

            updateMessagesArray(); // Update messages array after adding
            
            messageInput.value = '';
            messageInput.focus();
            scrollToBottom();
        }

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addMessage();
        });

        senderToggle.addEventListener('click', () => {
            isSender = !isSender;
            senderToggle.classList.toggle('receiver');
        });

        addMessageBtn.addEventListener('click', addMessage);

        // Add this after your existing variable declarations (but before the chatContainer declaration)
        const themeInputs = document.querySelectorAll('input[name="theme"]');

        // Add theme switching functionality
        themeInputs.forEach(input => {
            input.addEventListener('change', (e) => {
                const isDark = e.target.value === 'dark';
                chatContainer.classList.toggle('dark-theme', isDark);
                localStorage.setItem('chatTheme', e.target.value);
            });
        });

        // Load saved theme preference
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('chatTheme') || 'light';
            const themeInput = document.querySelector(`input[value="${savedTheme}"]`);
            if (themeInput) {
                themeInput.checked = true;
                chatContainer.classList.toggle('dark-theme', savedTheme === 'dark');
            }
        });

        // Update the generateBtn click handler to properly include theme information
        generateBtn.addEventListener('click', async () => {
            if (isGenerating) return;
            isGenerating = true;
            generateBtn.textContent = 'Generating...';
            
            try {
                updateMessagesArray();
                
                const currentProfileImage = document.getElementById('profileImage').src;
                const currentHeaderName = document.getElementById('headerName').textContent.trim();
                const currentTheme = document.querySelector('input[name="theme"]:checked').value;
                
                // Get voice selection (optional)
                const senderVoice = document.getElementById('senderVoice').value;
                const receiverVoice = document.getElementById('receiverVoice').value;
                
                const requestData = {
                    messages: messages,
                    profileImage: currentProfileImage,
                    headerName: currentHeaderName,
                    theme: currentTheme,  // This ensures the theme choice is sent to app.py
                    voiceSettings: {
                        apiKey: document.getElementById('elevenLabsKey').value,
                        voiceMap: voiceMap,
                        sender: senderVoice,
                        receiver: receiverVoice
                    },
                    backgroundVideo: document.querySelector('input[name="background"]:checked').value
                };
                
                console.log('Sending request with theme:', requestData.theme); // Debug log
                
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Video generation failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'output_video.mp4';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate video: ' + error.message);
            } finally {
                generateBtn.textContent = 'Generate Video';
                isGenerating = false;
            }
        });
        
        // Initialize scroll position when page loads
        window.addEventListener('load', scrollToBottom);

        // Message editing functionality
        let currentOptionsMenu = null;

        function createOptionsMenu(isPicture) {
            const menu = document.createElement('div');
            menu.className = 'message-options';
            menu.innerHTML = `
                <button class="edit">${isPicture ? 'Swap Picture' : 'Edit'}</button>
                <button class="switch">Switch Side</button>
                <button class="add-textbox-above">Add Textbox Above</button>
                <button class="add-textbox-below">Add Textbox Below</button>
                <button class="sound-effect">Sound Effects</button>
                <button class="delete">Delete</button>
            `;
            return menu;
        }

        function hideOptionsMenu() {
            if (currentOptionsMenu) {
                currentOptionsMenu.remove();
                currentOptionsMenu = null;
            }
        }

        function createSoundEffectsSubmenu(currentEffect) {
            const submenu = document.createElement('div');
            submenu.className = 'sound-effects-submenu';
            
            const effects = ['None', 'vineboom', 'notification', 'rizz', 'imessage_text'];
            
            effects.forEach(effect => {
                const option = document.createElement('div');
                option.className = `sound-effect-option ${currentEffect === effect ? 'selected' : ''}`;
                option.textContent = effect;
                
                const checkmark = document.createElement('span');
                checkmark.className = 'checkmark';
                checkmark.textContent = 'âœ“';
                option.appendChild(checkmark);
                
                option.addEventListener('click', () => {
                    // Remove selection from all options
                    submenu.querySelectorAll('.sound-effect-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Select the clicked option
                    option.classList.add('selected');
                });
                
                submenu.appendChild(option);
            });
            
            return submenu;
        }

        function handleMessageClick(e) {
            const messageDiv = e.target.closest('.message');
            if (!messageDiv) return;

            hideOptionsMenu();

            const optionsMenu = createOptionsMenu(messageDiv.classList.contains('picture'));

            // Append the menu to the body instead of the message
            document.body.appendChild(optionsMenu);
            currentOptionsMenu = optionsMenu;

            // Calculate the message's position relative to the viewport
            const messageRect = messageDiv.getBoundingClientRect();

            // Position the menu
            optionsMenu.style.display = 'block';
            optionsMenu.style.width = '200px';

            if (messageDiv.classList.contains('picture')) {
                // For pictures, position menu to the left
                optionsMenu.style.left = `${messageRect.left - 210}px`;
                optionsMenu.style.top = `${messageRect.top}px`;
            } else {
                // For text messages, position below
                optionsMenu.style.left = `${messageRect.left}px`;
                optionsMenu.style.top = `${messageRect.bottom}px`;
            }

            // Handle picture swap
            if (messageDiv.classList.contains('picture')) {
                optionsMenu.querySelector('.edit').onclick = (e) => {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.value = '';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = messageDiv.querySelector('img');
                                const newImg = new Image();
                                
                                newImg.onload = function() {
                                    // Calculate dimensions while maintaining aspect ratio
                                    const maxWidth = 200;
                                    const maxHeight = 300;
                                    let width = this.width;
                                    let height = this.height;
                                    
                                    if (width > maxWidth || height > maxHeight) {
                                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                                        width = width * ratio;
                                        height = height * ratio;
                                    }
                                    
                                    // Update the existing img element
                                    img.style.width = `${width}px`;
                                    img.style.height = `${height}px`;
                                    img.src = e.target.result;
                                    
                                    // Force the message container to adjust to new content
                                    messageDiv.style.width = 'auto';
                                    messageDiv.style.height = 'auto';
                                    
                                    updateMessagesArray();
                                };
                                
                                newImg.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                    input.click();
                    hideOptionsMenu();
                };
            } else {
                optionsMenu.querySelector('.edit').onclick = (e) => {
                    e.stopPropagation();
                    messageDiv.contentEditable = true;
                    messageDiv.focus();
                    hideOptionsMenu();
                    
                    messageDiv.addEventListener('input', () => {
                        updateMessagesArray();
                    });
                    
                    messageDiv.onblur = () => {
                        messageDiv.contentEditable = false;
                        updateMessagesArray();
                    };
                };
            }

            // Handle switch side
            optionsMenu.querySelector('.switch').onclick = (e) => {
                e.stopPropagation();
                const isSenderMessage = messageDiv.classList.contains('sender');
                messageDiv.classList.toggle('sender');
                messageDiv.classList.toggle('receiver');
                
                const index = Array.from(messageDiv.parentNode.children).indexOf(messageDiv);
                if (index !== -1 && messages[index]) {
                    messages[index].is_sender = !isSenderMessage;
                }
                hideOptionsMenu();
            };

            // Handle add textbox above
            optionsMenu.querySelector('.add-textbox-above').onclick = (e) => {
                e.stopPropagation();
                const newMessageDiv = document.createElement('div');
                newMessageDiv.className = `message ${messageDiv.classList.contains('sender') ? 'sender' : 'receiver'}`;
                newMessageDiv.textContent = 'New message';
                newMessageDiv.setAttribute('data-id', Date.now());
                messageDiv.parentNode.insertBefore(newMessageDiv, messageDiv);
                updateMessagesArray();
                hideOptionsMenu();
            };

            // Handle add textbox below
            optionsMenu.querySelector('.add-textbox-below').onclick = (e) => {
                e.stopPropagation();
                const newMessageDiv = document.createElement('div');
                newMessageDiv.className = `message ${messageDiv.classList.contains('sender') ? 'sender' : 'receiver'}`;
                newMessageDiv.textContent = 'New message';
                newMessageDiv.setAttribute('data-id', Date.now());
                messageDiv.parentNode.insertBefore(newMessageDiv, messageDiv.nextSibling);
                updateMessagesArray();
                hideOptionsMenu();
            };

            // Handle sound effects
            const soundEffectButton = optionsMenu.querySelector('.sound-effect');
            let soundEffectSubmenu = null;
            
            soundEffectButton.addEventListener('click', (e) => {
                e.stopPropagation();
                
                if (soundEffectSubmenu) {
                    soundEffectSubmenu.remove();
                    soundEffectSubmenu = null;
                    return;
                }
                
                const currentEffect = messageDiv.getAttribute('data-sound-effect');
                soundEffectSubmenu = createSoundEffectsSubmenu(currentEffect);
                
                // Position the submenu
                const buttonRect = soundEffectButton.getBoundingClientRect();
                soundEffectSubmenu.style.position = 'absolute';
                soundEffectSubmenu.style.left = `${buttonRect.right}px`;
                soundEffectSubmenu.style.top = `${buttonRect.top}px`;
                
                document.body.appendChild(soundEffectSubmenu);
                
                // Handle submenu clicks
                soundEffectSubmenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const selectedOption = e.target.closest('.sound-effect-option');
                    if (selectedOption) {
                        const selectedEffect = selectedOption.textContent.replace('âœ“', '').trim();
                        messageDiv.setAttribute('data-sound-effect', selectedEffect);
                        updateMessagesArray();
                    }
                });
            });

            // Handle delete
            optionsMenu.querySelector('.delete').onclick = (e) => {
                e.stopPropagation();
                messageDiv.remove();
                updateMessagesArray();
                hideOptionsMenu();
            };

            // Add click outside to close functionality
            const clickOutsideHandler = (e) => {
                if (!optionsMenu.contains(e.target) && 
                    !messageDiv.contains(e.target) &&
                    (!soundEffectSubmenu || !soundEffectSubmenu.contains(e.target))) {
                    hideOptionsMenu();
                    if (soundEffectSubmenu) {
                        soundEffectSubmenu.remove();
                        soundEffectSubmenu = null;
                    }
                    document.removeEventListener('click', clickOutsideHandler);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', clickOutsideHandler);
            }, 0);
        }

        messageContainer.addEventListener('click', handleMessageClick);

        // Global variables for voice management
        let voiceMap = {};
        let availableVoices = [];
        let isVoicesLoaded = false;

        // Add profile picture change functionality
        const profileImageContainer = document.getElementById('profileImageContainer');
        const profileImage = document.getElementById('profileImage');
        const profileUpload = document.getElementById('profileUpload');

        profileImageContainer.addEventListener('click', () => {
            profileUpload.click();
        });

        profileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    profileImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Always use default profile picture on page load
        profileImage.src = "{{ url_for('static', filename='images/profile.jpg') }}";

        // Voice fetching functionality
        const fetchVoicesBtn = document.getElementById('fetchVoicesBtn');
        const elevenLabsKeyInput = document.getElementById('elevenLabsKey');
        const senderVoiceSelect = document.getElementById('senderVoice');
        const receiverVoiceSelect = document.getElementById('receiverVoice');

        // Function to populate voice dropdowns
        function populateVoiceDropdowns(voices) {
            // Clear existing options except the first one
            senderVoiceSelect.innerHTML = '<option value="">No voice (optional)</option>';
            receiverVoiceSelect.innerHTML = '<option value="">No voice (optional)</option>';
            
            // Populate both dropdowns with fetched voices
            voices.forEach(voice => {
                const option1 = document.createElement('option');
                option1.value = voice.id;
                
                // Create display text with category info if available
                let displayText = voice.name;
                if (voice.category && voice.category !== 'unknown') {
                    displayText += ` (${voice.category})`;
                }
                option1.textContent = displayText;
                option1.setAttribute('data-category', voice.category);
                option1.setAttribute('data-description', voice.description);
                option1.title = voice.description || voice.name; // Tooltip with description
                
                const option2 = option1.cloneNode(true);
                
                senderVoiceSelect.appendChild(option1);
                receiverVoiceSelect.appendChild(option2);
            });
            
            // Update voice map for backend compatibility
            voiceMap = {};
            voices.forEach(voice => {
                voiceMap[voice.id] = voice.id;
            });
            
            availableVoices = voices;
            isVoicesLoaded = true;
            
            console.log('Voice dropdowns populated with', voices.length, 'voices');
        }

        // Function to show loading state
        function showLoadingState() {
            fetchVoicesBtn.textContent = 'Fetching Voices...';
            fetchVoicesBtn.disabled = true;
            fetchVoicesBtn.style.opacity = '0.6';
        }

        // Function to hide loading state
        function hideLoadingState() {
            fetchVoicesBtn.textContent = 'Fetch Voices';
            fetchVoicesBtn.disabled = false;
            fetchVoicesBtn.style.opacity = '1';
        }

        // Function to show success message
        function showSuccessMessage(message) {
            // Create or update success message
            let successMsg = document.getElementById('voiceSuccessMsg');
            if (!successMsg) {
                successMsg = document.createElement('div');
                successMsg.id = 'voiceSuccessMsg';
                successMsg.style.cssText = `
                    color: #28a745;
                    font-size: 12px;
                    margin-top: 5px;
                    text-align: center;
                    padding: 5px;
                    background: #d4edda;
                    border: 1px solid #c3e6cb;
                    border-radius: 4px;
                `;
                elevenLabsKeyInput.parentNode.appendChild(successMsg);
            }
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 5000);
        }

        // Function to show error message
        function showErrorMessage(message) {
            // Create or update error message
            let errorMsg = document.getElementById('voiceErrorMsg');
            if (!errorMsg) {
                errorMsg = document.createElement('div');
                errorMsg.id = 'voiceErrorMsg';
                errorMsg.style.cssText = `
                    color: #dc3545;
                    font-size: 12px;
                    margin-top: 5px;
                    text-align: center;
                    padding: 5px;
                    background: #f8d7da;
                    border: 1px solid #f5c6cb;
                    border-radius: 4px;
                `;
                elevenLabsKeyInput.parentNode.appendChild(errorMsg);
            }
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            
            // Hide after 8 seconds
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 8000);
        }

        // Fetch voices button click handler
        fetchVoicesBtn.addEventListener('click', async () => {
            const apiKey = elevenLabsKeyInput.value.trim();
            
            if (!apiKey) {
                showErrorMessage('Please enter your ElevenLabs API key first');
                elevenLabsKeyInput.focus();
                return;
            }
            
            showLoadingState();
            
            try {
                const response = await fetch('/api/fetch-voices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ apiKey: apiKey })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch voices');
                }
                
                if (data.voices && data.voices.length > 0) {
                    populateVoiceDropdowns(data.voices);
                    showSuccessMessage(data.message || `Successfully loaded ${data.voices.length} voices from your ElevenLabs account`);
                } else {
                    showErrorMessage('No voices found in your ElevenLabs account.');
                }
                
            } catch (error) {
                console.error('Error fetching voices:', error);
                showErrorMessage('Error fetching voices: ' + error.message);
            } finally {
                hideLoadingState();
            }
        });

        // Auto-fetch voices when API key is entered (optional)
        elevenLabsKeyInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && elevenLabsKeyInput.value.trim()) {
                fetchVoicesBtn.click();
            }
        });

        // Import Dialogue functionality
        const importDialogueBtn = document.getElementById('importDialogueBtn');
        const importModal = document.getElementById('importModal');
        const closeImportModal = document.getElementById('closeImportModal');
        const cancelImport = document.getElementById('cancelImport');
        const confirmImport = document.getElementById('confirmImport');
        const dialogueInput = document.getElementById('dialogueInput');

        // Open import modal
        importDialogueBtn.addEventListener('click', () => {
            importModal.style.display = 'flex';
            dialogueInput.focus();
        });

        // Close import modal
        function closeModal() {
            importModal.style.display = 'none';
            dialogueInput.value = '';
        }

        closeImportModal.addEventListener('click', closeModal);
        cancelImport.addEventListener('click', closeModal);

        // Close modal when clicking outside
        importModal.addEventListener('click', (e) => {
            if (e.target === importModal) {
                closeModal();
            }
        });

        // Parse dialogue and convert to messages
        function parseDialogue(dialogueText) {
            const lines = dialogueText.split('\n').filter(line => line.trim());
            const messages = [];
            const speakerMapping = document.querySelector('input[name="speakerMapping"]:checked').value;
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;
                
                // Match pattern: A: message or B: message
                const match = trimmedLine.match(/^([AB]):\s*(.+)$/i);
                if (match) {
                    const speaker = match[1].toUpperCase();
                    const message = match[2].trim();
                    
                    if (message) {
                        let isSender;
                        if (speakerMapping === 'AB') {
                            isSender = speaker === 'A';
                        } else {
                            isSender = speaker === 'B';
                        }
                        
                        messages.push({
                            id: Date.now() + Math.random(),
                            text: message,
                            is_sender: isSender,
                            type: 'text'
                        });
                    }
                }
            }
            
            return messages;
        }

        // Import messages
        confirmImport.addEventListener('click', () => {
            const dialogueText = dialogueInput.value.trim();
            
            if (!dialogueText) {
                alert('Please enter some dialogue to import.');
                return;
            }
            
            try {
                const newMessages = parseDialogue(dialogueText);
                
                if (newMessages.length === 0) {
                    alert('No valid dialogue found. Please check your format.');
                    return;
                }
                
                // Clear existing messages
                const dynamicContainer = document.querySelector('.dynamic-container');
                dynamicContainer.innerHTML = '';
                
                // Add new messages
                newMessages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.is_sender ? 'sender' : 'receiver'}`;
                    messageDiv.textContent = msg.text;
                    messageDiv.setAttribute('data-id', msg.id);
                    dynamicContainer.appendChild(messageDiv);
                });
                
                // Update messages array
                updateMessagesArray();
                scrollToBottom();
                
                // Close modal
                closeModal();
                
                // Show success message
                alert(`Successfully imported ${newMessages.length} messages!`);
                
            } catch (error) {
                console.error('Error parsing dialogue:', error);
                alert('Error parsing dialogue. Please check your format and try again.');
            }
        });

        // Handle Enter key in textarea (Shift+Enter for new line, Enter to import)
        dialogueInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                confirmImport.click();
            }
        });
    </script>
</body>
</html>